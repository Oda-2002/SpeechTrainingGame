<!DOCTYPE html>
<html>
<head>
    <title>Pitch Detection</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/addons/p5.sound.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ml5/0.12.2/ml5.min.js"></script>
    <style>
        * { font-family: 'Noto Sans JP', sans-serif !important; }
        #debug {
            font-family: Arial, sans-serif;
            background: #f0f0f0;
            padding: 10px;
            border: 1px solid #ccc;
            margin: 20px;
            overflow-y: auto;
            max-height: 300px;
        }
    </style>
</head>
<body>
    <div id="debug">Loading model...</div>
    <script>
        let mic, pitch, audioContext;
        let currentPitch = 0;

    function setup() {
        createCanvas(400, 400);
        mic = new p5.AudioIn();
        mic.start(initPitch);

        audioContext = getAudioContext();
        console.log('AudioContext state:', audioContext.state);
        updateDebug(`AudioContext state: ${audioContext.state}`);

        // Ensure audio context resumes on button click
        document.getElementById('detectButton').addEventListener('click', function() {
            if (audioContext.state === 'suspended') {
                audioContext.resume().then(() => {
                    console.log('Playback resumed successfully on click');
                    updateDebug('Playback resumed successfully on click');
                    getPitch(); // Start pitch detection after audio context is resumed
                }).catch(err => {
                    console.error('Playback resume failed on click', err);
                    updateDebug(`Playback resume failed on click: ${err}`);
                });
            } else {
                getPitch(); // Start pitch detection immediately if audio context is already running
            }
        });

        ensureAudioContextRunning();
    }

    function ensureAudioContextRunning() {
        if (audioContext.state === 'suspended') {
            audioContext.resume().then(() => {
                console.log('Playback resumed successfully');
                updateDebug('Playback resumed successfully');
            }).catch(err => {
                console.error('Playback resume failed', err);
                updateDebug(`Playback resume failed: ${err}`);
            });
            setTimeout(ensureAudioContextRunning, 1000); // 1秒後に再試行
        }
    }

    function initPitch() {
        console.log('Microphone initialized');
        updateDebug('Microphone initialized');

        const modelUrl = 'https://cdn.jsdelivr.net/gh/ml5js/ml5-data-and-models@main/models/crepe';
        ml5.pitchDetection(modelUrl, getAudioContext(), mic.stream)
            .then((pd) => {
                pitch = pd;
                modelLoaded();
            })
            .catch((err) => {
                modelError(err);
            });
    }

    function modelLoaded() {
        console.log('Model Loaded!');
        updateDebug('Model Loaded!');
    }

    function modelError(err) {
        console.error('Model Load Error:', err);
        updateDebug(`Model Load Error: ${err}`);
    }

    function getPitch() {
        if (!pitch) return;

        pitch.getPitch((err, frequency) => {
            if (err) {
                console.error(err);
                updateDebug(`Error: ${err}`);
            } else if (frequency) {
                currentPitch = frequency;
                updateDebug(`Detected pitch: ${currentPitch}`);
            } else {
                currentPitch = 0;
                updateDebug('No pitch detected');
            }
            setTimeout(getPitch, 100); // Regularly check for pitch
        });
    }

    function updateDebug(message) {
        const debugDiv = document.getElementById('debug');
        debugDiv.innerHTML += `<p>${message}</p>`;
        debugDiv.scrollTop = debugDiv.scrollHeight;
    }

    function draw() {
        background(200);
        fill(0);
        textSize(16);
        textAlign(LEFT, TOP);
        let micLevel = mic.getLevel();
        text(`Mic Level: ${micLevel.toFixed(3)}`, 10, 10);
        text(`Pitch: ${currentPitch.toFixed(2)} Hz`, 10, 30);

        let barHeight = map(currentPitch, 50, 1000, 0, height);
        fill(0, 0, 255);
        rect(width / 2 - 25, height - barHeight, 50, barHeight);
    }
</script>
</body>
</html>